# 事务

- 事务是用户定义的一个数据库操作序列，这些操作要么全做，要么全不做，是一个不可分割的工作单位。

- 事务以 begin transaction 开始，以commit 或者 rollback 结束

    - commit 表示提交，即将事务中对数据库的所有更新写入到磁盘上的物理数据库中，事务正常结束。
    - rollback 表示回滚，即在事务的运行过程中发生了某种故障，事务不能继续执行，系统将对事务中对数据库的所有已完成的操作全部撤销，回滚到事务开始时的状态。


## 事务的ACID特性
- 事务具有四个特性：原子性(atomicity)、一致性、隔离性和持续性。
1. 原子性

    事务是数据库的逻辑工作单位，事务中的所有操作要么做，要么全不做

2. 一致性

    事务执行的结果必须是从一个一致性状态转移到另一个一致性状态。
    
    因此当数据库中只包含成功事务提交的结果是，就说数据库处于一个一致性状态

    由此可见，一致性和原子性是密切相关的。

3. 隔离性

    一个事务的执行不能被其他事务干扰。
    
    即一个事务的内部操作以及使用的数据对象对其他并发事务是隔离的，并发控制的各个事务之间不能互相干扰。


4. 持续性

    持续性也成为了永久性。

    即一个事务的内部操作一旦提交，那么它对数据库中数据的改变就应该是永久的，接下来的其他操作或故障不应该对其执行结果有任何的影响。


- 事务是恢复和并发控制的基本单位。保证事务ACID特性是事务管理中的重要任务。

***


## 事务的三级封锁协议

1. 一级封锁协议：事务T中如果对数据R有写操作，必须在这个事务中对R的第一次读操作前对它加X锁，
直到事务结束才释放。事务结束包括正常结束（COMMIT）和非正常结束（ROLLBACK）。

2. 二级封锁协议：一级封锁协议加上事务T在读取数据R之前必须先对其加S锁，读完后方可释放S锁。

3. 三级封锁协议 ：一级封锁协议加上事务T在读取数据R之前必须先对其加S锁，直到事务结束才释放。

三级锁操作一个比一个厉害（满足高级锁则一定满足低级锁）。但有个非常致命的地方，
一级锁协议就要在第一次读加x锁，直到事务结束。几乎就要在整个事务加写锁了，效率非常低。
三级封锁协议只是一个理论上的东西，实际数据库常用另一套方法来解决事务并发问题。
